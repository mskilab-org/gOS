name: Build and Publish Artifacts
on:
  push:
    branches: ["main"]

# Needed so the workflow can push to the artifacts branch
permissions:
  contents: write

# Cancel in-flight older runs if you push again
concurrency:
  group: build-artifacts
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node 16
        uses: actions/setup-node@v4
        with:
          node-version: "16.x"
          cache: "yarn"

      - name: Install deps
        run: yarn install --frozen-lockfile

      - name: Setup SSH for git pushes
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_DEPLOY_KEY }}

      - name: Add github.com to known_hosts
        run: ssh-keyscan -t rsa,ecdsa,ed25519 github.com >> ~/.ssh/known_hosts

      - name: Build
        env:
          # give webpack more headroom; harmless on CI
          NODE_OPTIONS: --max-old-space-size=4096
          # optional: smaller uploads
          # GENERATE_SOURCEMAP: 'false'
        run: CI=false yarn build

      - name: Package build as tar.gz
        run: |
          mkdir -p out
          TARBALL="build-${GITHUB_SHA}.tar.gz"
          tar -czf "out/${TARBALL}" -C build .
          sha256sum "out/${TARBALL}" > "out/${TARBALL}.sha256"
          echo "${GITHUB_SHA}" > out/LATEST.txt
          date -u +"%Y-%m-%dT%H:%M:%SZ" > out/LATEST_BUILT_AT.txt

      - name: Publish to deploy-builds branch
        run: |
          set -e
          BRANCH=deploy-builds
          REPO="git@github.com:${GITHUB_REPOSITORY}.git"

          # fresh shallow clone of the artifacts branch (handles latest state)
          rm -rf artifacts
          if git ls-remote --heads "$REPO" "${BRANCH}" | grep -q "refs/heads/${BRANCH}"; then
            git clone --branch ${BRANCH} --single-branch --depth=1 "$REPO" artifacts
          else
            # create the branch if it doesn't exist yet
            mkdir artifacts && cd artifacts
            git init
            git remote add origin "$REPO"
            git checkout -b ${BRANCH}
            echo "# Prebuilt artifacts" > README.md
            git add README.md
            git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" \
              commit -m "init artifacts branch"
            git push -u origin ${BRANCH}
            cd ..
          fi

          mkdir -p artifacts/releases
          cp out/build-${GITHUB_SHA}.tar.gz artifacts/releases/
          cp out/build-${GITHUB_SHA}.tar.gz.sha256 artifacts/releases/
          cp out/LATEST.txt artifacts/
          cp out/LATEST_BUILT_AT.txt artifacts/

          cd artifacts
          git add -A
          git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" \
            commit -m "build: ${GITHUB_SHA}" || echo "No changes to commit"
          git push origin HEAD:${BRANCH}

      # (Optional) keep branch size under control â€” keep last 5 tarballs
      - name: Prune old tarballs (optional)
        if: always()
        run: |
          set -e
          BRANCH=deploy-builds
          REPO="git@github.com:${GITHUB_REPOSITORY}.git"
          rm -rf artifacts_prune
          git clone --branch ${BRANCH} --single-branch --depth=1 "$REPO" artifacts_prune
          if [ ! -d artifacts_prune/releases ]; then
            echo "No releases to prune yet; skipping"
            exit 0
          fi
          cd artifacts_prune/releases
          shopt -s nullglob
          ls -1tr build-*.tar.gz | head -n -5 | xargs -r -I{} bash -c 'rm -f "{}" "{}".sha256'
          cd ..
          git add -A
          git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" \
            commit -m "chore: prune old tarballs" || echo "nothing to prune"
          git push origin HEAD:${BRANCH}
