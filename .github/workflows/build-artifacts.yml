name: Build and Publish Artifacts
on:
  push:
    branches: ["main"]

# Needed so the workflow can push to the artifacts branch
permissions:
  contents: write

# Cancel in-flight older runs if you push again
concurrency:
  group: build-artifacts
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH for git pushes
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_DEPLOY_KEY }}

      - name: Add github.com to known_hosts
        run: ssh-keyscan -t rsa,ecdsa,ed25519 github.com >> ~/.ssh/known_hosts

      # (Optional) keep branch size under control â€” prune before producing new build
      - name: Prune old tarballs and clean git history
        if: always()
        run: |
          set -e
          BRANCH=deploy-builds
          REPO="git@github.com:${GITHUB_REPOSITORY}.git"
          rm -rf artifacts_prune

          # Clone with full history for proper cleanup
          git clone --branch ${BRANCH} "$REPO" artifacts_prune
          if [ ! -d artifacts_prune/releases ]; then
            echo "No releases to prune yet; skipping"
            exit 0
          fi
          cd artifacts_prune
          shopt -s nullglob
          KEEP=2  # Keep only 2 most recent releases instead of 5
          mapfile -t tarballs < <(git ls-files releases/build-*.tar.gz)

          if (( ${#tarballs[@]} > KEEP )); then
            echo "Found ${#tarballs[@]} tarballs, keeping ${KEEP} most recent"
            mapfile -t sorted < <(
              for file in "${tarballs[@]}"; do
                ts=$(git log -1 --format=%ct -- "$file" || echo 0)
                printf '%s\t%s\n' "$ts" "$file"
              done | sort -n | cut -f2-
            )
            
            # Files to keep (most recent ones)
            files_to_keep=("${sorted[@]: -KEEP}")
            echo "Keeping files: ${files_to_keep[*]}"
            
            # Create clean repository with only files we want to keep
            cd ..
            rm -rf artifacts_clean
            mkdir artifacts_clean && cd artifacts_clean
            git init
            git remote add origin "$REPO"
            git checkout -b ${BRANCH}
            
            # Copy only the files we want to keep
            mkdir -p releases
            for file in "${files_to_keep[@]}"; do
              if [ -f "../artifacts_prune/$file" ]; then
                cp "../artifacts_prune/$file" "$file"
                cp "../artifacts_prune/$file.sha256" "$file.sha256" 2>/dev/null || true
              fi
            done
            
            # Copy other important files
            cp ../artifacts_prune/README.md . 2>/dev/null || echo "# Prebuilt artifacts" > README.md
            cp ../artifacts_prune/LATEST.txt . 2>/dev/null || true
            cp ../artifacts_prune/LATEST_BUILT_AT.txt . 2>/dev/null || true
            cp -R ../artifacts_prune/.github . 2>/dev/null || true
            cp -R ../artifacts_prune/screenshots . 2>/dev/null || true
            cp ../artifacts_prune/setup.sh . 2>/dev/null || true
            cp -R ../artifacts_prune/shared . 2>/dev/null || true
            
            # Commit the clean state
            git add -A
            git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" \
              commit -m "chore: clean repository, keep only ${KEEP} most recent builds"
            
            # Force push the clean history (this removes all traces of old files)
            git push --force origin HEAD:${BRANCH}
            echo "Successfully pruned to ${KEEP} builds and cleaned git history"
          else
            echo "Only ${#tarballs[@]} tarballs found, no pruning needed (keeping ${KEEP})"
          fi

      - name: Use Node 16
        uses: actions/setup-node@v4
        with:
          node-version: "16.x"
          cache: "yarn"

      - name: Install deps
        run: yarn install --frozen-lockfile

      - name: Build
        env:
          # give webpack more headroom; harmless on CI
          NODE_OPTIONS: --max-old-space-size=4096
          # optional: smaller uploads
          # GENERATE_SOURCEMAP: 'false'
        run: CI=false yarn build

      - name: Package build as tar.gz
        run: |
          mkdir -p out
          TARBALL="build-${GITHUB_SHA}.tar.gz"
          tar -czf "out/${TARBALL}" -C build .
          sha256sum "out/${TARBALL}" > "out/${TARBALL}.sha256"
          echo "${GITHUB_SHA}" > out/LATEST.txt
          date -u +"%Y-%m-%dT%H:%M:%SZ" > out/LATEST_BUILT_AT.txt

      - name: Publish to deploy-builds branch
        run: |
          set -e
          BRANCH=deploy-builds
          REPO="git@github.com:${GITHUB_REPOSITORY}.git"

          # fresh shallow clone of the artifacts branch (handles latest state)
          rm -rf artifacts
          if git ls-remote --heads "$REPO" "${BRANCH}" | grep -q "refs/heads/${BRANCH}"; then
            git clone --branch ${BRANCH} --single-branch --depth=1 "$REPO" artifacts
          else
            # create the branch if it doesn't exist yet
            mkdir artifacts && cd artifacts
            git init
            git remote add origin "$REPO"
            git checkout -b ${BRANCH}
            echo "# Prebuilt artifacts" > README.md
            git add README.md
            git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" \
              commit -m "init artifacts branch"
            git push -u origin ${BRANCH}
            cd ..
          fi

          mkdir -p artifacts/releases
          cp out/build-${GITHUB_SHA}.tar.gz artifacts/releases/
          cp out/build-${GITHUB_SHA}.tar.gz.sha256 artifacts/releases/
          cp out/LATEST.txt artifacts/
          cp out/LATEST_BUILT_AT.txt artifacts/

          cd artifacts
          git add -A
          git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" \
            commit -m "build: ${GITHUB_SHA}" || echo "No changes to commit"
          git push origin HEAD:${BRANCH}
